<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>World Macro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#eef;color:#111;text-align:center}
h1{margin:8px 0;font-size:20px}
#controls{padding:8px}
select{padding:9px 12px;font-size:12px;border-radius:6px;border:1px solid #bbb;background:#fff;margin-right:6px}
#map{height:72vh;max-height:800px;width:95%;max-width:1200px;margin:12px auto;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.15)}
.pin{white-space:nowrap;display:flex;flex-direction:column;align-items:center;padding:4px 6px;border-radius:4px;background:rgba(255,255,255,0.65);box-shadow:0 1px 2px rgba(0,0,0,.12);text-align:center;border:1px solid rgba(0,0,0,.06);font-size:var(--fs,12px)}
.pin img{width:18px;height:12px;margin-bottom:2px}
#status{font-size:11px;color:#555;margin-top:5px}
#source{font-size:10px;color:#555;margin:6px auto;max-width:800px}
#source a{color:#2b7cff;text-decoration:none}
</style>
</head>
<body>
<h1>World Macro</h1>

<div id="controls">
<select id="stat">
  <option value="">Select KPI…</option>
  <option value="GDP">GDP (US$B)</option>
  <option value="GDPpc">GDP per capita (US$)</option>
  <option value="Infl">Inflation (%)</option>
  <option value="Unemp">Unemployment (%)</option>
</select>
<select id="year"><option>–</option></select>
</div>

<div id="map"></div>
<div id="source">Data source: <a href="https://data.worldbank.org/" target="_blank">World Bank</a></div>
<div id="status">Ready.</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const flagURL=c=>`https://flagcdn.com/24x18/${c.toLowerCase()}.png`;
const WB_IND={GDP:'NY.GDP.MKTP.CD',GDPpc:'NY.GDP.PCAP.CD',Infl:'FP.CPI.TOTL.ZG',Unemp:'SL.UEM.TOTL.ZS'};
const REVERSE_GREEN=['Infl','Unemp'];
const statSel=document.getElementById('stat'),yrSel=document.getElementById('year'),status=document.getElementById('status');
const map=L.map('map',{worldCopyJump:true}).setView([15,10],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"© OpenStreetMap"}).addTo(map);

let markers=[];
function clearPins(){markers.forEach(m=>map.removeLayer(m));markers=[];}
function fmt(v,s){if(v==null)return'–';if(s==='GDP')return(v/1e9).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,".")+'B';if(s==='GDPpc')return Math.round(v).toLocaleString();if(s==='Infl'||s==='Unemp')return (Math.round(v*10)/10)+'%';return v;}
function trend(a,b){if(a==null||b==null)return'';a=+a;b=+b;if(isNaN(a)||isNaN(b))return'';return Math.abs(a-b)<=Math.abs(b)*.005?'→':a>b?'⬆️':'⬇️';}
function color(v,min,max,rev){if(v==null||!isFinite(v))return'rgba(200,200,200,.6)';let t=(v-min)/(max-min);t=Math.max(0,Math.min(1,t));if(rev)t=1-t;return`hsl(${120*t},${55+10*t}%,${65-15*t}%)`;}
function pin(p,val,col){const h=`<div class="pin" style="--fs:${Math.max(10,12-(3-Math.min(3,Math.max(0,map.getZoom()-2))))}px;background:${col}"><img src="${flagURL(p.cc)}"><strong>${p.code}</strong><div>${val}</div></div>`;const ic=L.divIcon({html:h,className:'',iconSize:null});const m=L.marker([p.lat,p.lon],{icon:ic}).addTo(map);markers.push(m);}
async function wb(cc,i){try{const r=await fetch(`https://api.worldbank.org/v2/country/${cc}/indicator/${i}?format=json&per_page=6&date=2000:2025`);const j=await r.json();return (j[1]||[]).filter(d=>d.value!=null).slice(0,4);}catch{return[];}}
async function loadYears(){const c=PLACES[0],d=await wb(c.code,WB_IND[statSel.value]);yrSel.innerHTML=d.length?`<option value="0">Latest</option>`:`<option>–</option>`;for(let i=1;i<d.length;i++)yrSel.innerHTML+=`<option value="${i}">Period -${i}</option>`;}
function updTitle(all){let y='–';for(const k in all){const d=all[k][+yrSel.value];if(d?.date){y=d.date;break;}}document.title=`World Macro — ${y}`;document.querySelector('h1').textContent=`World Macro (${y})`;}

// from Code 1: country positions (trimmed only to essential fields)
const COUNTRIES=[["DZ",28,1.66],["LY",26.34,17.23],["TN",33.8869,9.5375],["EG",26.82,30.8],["MA",32,-5],["ZA",-29,24],
["US",38,-97],["CA",60,-95],["BR",-10,-55],["AR",-34,-64],["MX",23,-102],["GB",54,-2],["DE",51,9],["FR",46,2],
["IT",42.8,12.8],["ES",40,-4],["PL",52,20],["RU",60,100],["CN",35,105],["JP",36,138],["IN",20,77],["AU",-27,133]];
const PLACES=COUNTRIES.map(([c,lat,lon])=>({code:c,cc:c.toLowerCase(),lat,lon}));

async function showStat(){
  if(!statSel.value)return;
  clearPins();status.textContent=`Loading ${statSel.value}…`;
  const stat=statSel.value,per=+yrSel.value;const vals=[],all={};
  const chunks=[];for(let i=0;i<PLACES.length;i+=10)chunks.push(PLACES.slice(i,i+10));
  for(const chunk of chunks){
    const batch=await Promise.all(chunk.map(async p=>{
      const d=await wb(p.code,WB_IND[stat]);all[p.code]=d;const r=d[per]||{};if(r.value!=null)vals.push(r.value);
      return {p,d};
    }));
    const f=vals.filter(v=>isFinite(v));const mn=f.length?Math.min(...f):0,mx=f.length?Math.max(...f):1;
    batch.forEach(({p,d})=>{
      const r=d[per]||{},pr=d[per+1]?.value,v=fmt(r.value,stat)+trend(r.value,pr),rev=REVERSE_GREEN.includes(stat);
      pin(p,v,color(r.value,mn,mx,rev));
    });
    await new Promise(r=>setTimeout(r,150)); // rate limit delay
  }
  updTitle(all);status.textContent='Done.';
}

statSel.addEventListener('change',async()=>{if(!statSel.value)return;await loadYears();yrSel.value='0';showStat();});
yrSel.addEventListener('change',showStat);
map.on('zoomend',()=>{const z=map.getZoom();document.querySelectorAll('.pin').forEach(p=>p.style.setProperty('--fs',Math.max(10,z*1.5)+'px'));});
</script>
</body>
</html>
